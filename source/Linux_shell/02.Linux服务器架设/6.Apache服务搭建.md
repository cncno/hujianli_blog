# Apache服务源码搭建
Apache 是世界使用排名第一的 Web 服务器软件。

	它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的 Web 服务器端软件之一。
	Apache HTTP Server（简称 Apache）是 Apache 软件基金会的一个开放源码的网页
	服务器，可以在大多数计算机操作系统中运行，由于其多平台和安全性被广泛使用，是最流
	行的 Web 服务器端软件之一。它快速、可靠并且可通过简单的 API 扩展，将 Perl/Python
	等解释器编译到服务器中。


    Apache HTTP 服务器是一个模块化的服务器，源于 NCSAhttpd 服务器，经过多次修
    改，成为世界使用排名第一的 Web 服务器软件。


    Apache 源于 NCSAhttpd 服务器，经过多次修改，成为世界上最流行的 Web 服务器
    软件之一。Apache 取自“a patchy server”的读音，意思是充满补丁的服务器，因为它
    是自由软件，所以不断有人来为它开发新的功能、新的特性、修改原来的缺陷。




## Apache 的特点
    简单、速度快、性能稳定，并可做代理服务器来使用。


prefork 的工作原理

	如果不用“——with-mpm”显式指定某种 MPM,prefork 就是 Unix 平台上缺省的
	MPM.它所采用的预派生子进程方式也是 Apache1.3 中采用的模式.prefork 本身并没有使
	用到线程,2.0版使用它是为了与1.3版保持兼容性;另一方面,prefork用单独的子进程来处理
	不同的请求,进程之间是彼此独立的,这也使其成为最稳定的 MPM 之一.
	prefork 的工作原理是,控制进程在最初建立“StartServers”个子进程后,为了满足
	MinSpareServers 设置的需要创建一个进程,等待一秒钟,继续创建两个,再等待一秒钟,继续
	创建四个……如此按指数级增加创建的进程数,最多达到每秒 32 个,直到满足
	MinSpareServers 设置的值为止.这就是预派生（prefork）的由来.这种模式可以不必在请
	求到来时再产生新的进程,从而减小了系统开销以增加性能.


worker 的工作原理

    相对于 prefork,worker 是 2.0 版中全新的支持多线程和多进程混合模型的 MPM.由于
    使用线程来处理,所以可以处理相对海量的请求,而系统资源的开销要小于基于进程的服务器.
    但是,worker 也使用了多进程,每个进程又生成多个线程,以获得基于进程服务器的稳定性.这
    种 MPM 的工作方式将是 Apache2.0 的发展趋势.
    资源由 www.eimhe.com  美河学习在线收集分享
    worker 的工作原理是,由主控制进程生成“StartServers”个子进程,每个子进程中包含
    固定的 ThreadsPerChild 线程数,各个线程独立地处理请求.同样,为了不在请求到来时再生
    成线程,MinSpareThreads 和 MaxSpareThreads 设置了最少和最多的空闲线程数;而
    MaxClients 设置了所有子进程中的线程总数.如果现有子进程中的线程总数不能满足负载,
    控制进程将派生新的子进程.


Worker 模式下所能同时处理的请求总数 是由子进程总
数乘以 ThreadsPerChild 值决定的,应该大于等于 MaxClients.如果负载很大,现有的子进程
数不能满足时,控制进程会派生新的子进程.默认最大的子进程总数是 16,加大时也需要显式
声明 ServerLimit（最大值是 20000）
需要注意的是,如果显式声明了 ServerLimit,那么它乘以 ThreadsPerChild 的值必须大于等
于 MaxClients,而且 MaxClients 必须是 ThreadsPerChild 的整数倍,否则 Apache 将会自
动调节到一个相应值（可能是个非期望值）.
    
    在大多数平台上，Prefork MPM 在效率上要比 Worker MPM 要高，但是内存使用大
    得多。
    
    prefork 的无线程设计在某些情况下将比 worker 更有优势：它可以使用那些没有处
    理好线程安全的第三方模块，并且对于那些线程调试困难的平台而言，它也更容易调试一些。

    Worker 模式：Worker MPM 使用多个子进程，每个子进程有多个线程。每个线程在
    某个确定的时间只能维持一个连接。通常来说，在一个高流量的 HTTP 服务器上，Worker
    MPM 是个比较好的选择，因为 Worker MPM 的内存使用比 Prefork MPM 要低得多。


    Worker MPM 也由不完善的地方，如果一个线程崩溃，整个进程就会连同其所有线程
    一起"死掉".由于线程共享内存空间，所以一个程序在运行时必须被系统识别为"每个线程都
    是安全的"。


## Apache 源码安装编译配置

```
wget http://mirrors.hust.edu.cn/apache/httpd/httpd-2.4.38.tar.gz
tar xf httpd-2.4.38.tar.gz 
yum -y install apr apr-util apr-devel apr-util-devel pcre*
./configure --prefix=/usr/local/apache2 --enable-rewrite --enable-so
make && make install

#启动apache服务
[root@iZ2zedqzq67rmpf60igjz6Z httpd-2.4.38]# /usr/local/apache2/bin/apachectl start


#查看进程
[root@iZ2zedqzq67rmpf60igjz6Z httpd-2.4.38]# ps aux | grep httpd
root     22504  0.0  0.0  74924  2392 ?        Ss   12:29   0:00 /usr/local/apache2/bin/httpd -k start
daemon   22505  0.0  0.0 363888  4268 ?        Sl   12:29   0:00 /usr/local/apache2/bin/httpd -k start
daemon   22506  0.0  0.0 363888  4268 ?        Sl   12:29   0:00 /usr/local/apache2/bin/httpd -k start
daemon   22507  0.0  0.0 429424  4260 ?        Sl   12:29   0:00 /usr/local/apache2/bin/httpd -k start
root     22593  0.0  0.0 112708   980 pts/0    S+   12:29   0:00 grep --color=auto httpd
[root@iZ2zedqzq67rmpf60igjz6Z httpd-2.4.38]# netstat -tnl| grep 80
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN     


[root@iZ2zedqzq67rmpf60igjz6Z httpd-2.4.38]# yum -y install lsof

[root@iZ2zedqzq67rmpf60igjz6Z httpd-2.4.38]# lsof -i:80
COMMAND     PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
AliYunDun  3605   root   21u  IPv4  24349      0t0  TCP iZ2zedqzq67rmpf60igjz6Z:38072->100.100.30.25:http (ESTABLISHED)
httpd     22504   root    3u  IPv4 130564      0t0  TCP *:http (LISTEN)
httpd     22505 daemon    3u  IPv4 130564      0t0  TCP *:http (LISTEN)
httpd     22506 daemon    3u  IPv4 130564      0t0  TCP *:http (LISTEN)
httpd     22507 daemon    3u  IPv4 130564      0t0  TCP *:http (LISTEN)

#源码包安装 Apache 默认发布目录为:/usr/local/apache2/htdocs/下。
```


